{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Gi·ªè h√†ng - N·ªôi Th·∫•t ƒê·∫πp{% endblock %}

{% block content %}
<div class="cart-page container py-4">
  <h2 class="mb-4 fw-bold">üõçÔ∏è Gi·ªè h√†ng c·ªßa b·∫°n</h2>

  {% if items %}
  <form method="post" action="{% url 'update_cart' %}">
    {% csrf_token %}
    <!-- ƒë√£ s·ª≠a th√™m -->
    <input type="hidden" name="from_cart" value="true">

    <table class="table align-middle text-center border">
      <thead class="table-light">
        <tr>
          <th style="width: 5%"></th> <!-- C·ªôt checkbox -->
          <th style="width: 35%">S·∫£n ph·∫©m</th>
          <th style="width: 15%">ƒê∆°n gi√°</th>
          <th style="width: 15%">S·ªë l∆∞·ª£ng</th>
          <th style="width: 15%">S·ªë ti·ªÅn</th>
          <th style="width: 15%">Thao t√°c</th>
        </tr>
      </thead>

      <tbody>
        {% for row in items %}
        <tr>
          <!-- √î tick -->
          <td>
            <!-- ƒë√£ s·ª≠a -->
            <input type="checkbox" class="item-checkbox" name="selected_items" value="{{ row.product.id }}" checked>
          </td>

          <!-- Th√¥ng tin s·∫£n ph·∫©m -->
          <td class="text-start">
            <div class="d-flex align-items-center gap-3">
              {% with img=row.product.images.first %}
                {% if img %}
                  <img src="{{ img.url }}" alt="{{ row.product.name }}" style="width:80px; height:80px; object-fit:cover; border-radius:6px;">
                {% else %}
                  <img src="{% static 'assets/img/default.jpg' %}" alt="{{ row.product.name }}" style="width:80px; height:80px; object-fit:cover; border-radius:6px;">
                {% endif %}
              {% endwith %}
              <div>
                <div class="fw-semibold">{{ row.product.name }}</div>
                <small class="text-muted">M√£ SP: {{ row.product.id }}</small>
              </div>
            </div>
          </td>

          <!-- ƒê∆°n gi√° -->
          <td class="price">{{ row.product.price|floatformat:0|intcomma }}‚Ç´</td>
          
          <!-- S·ªë l∆∞·ª£ng -->
          <td>
            <div class="d-inline-flex align-items-center justify-content-center">
              <button type="button" class="btn btn-outline-secondary btn-sm" onclick="changeQty({{ row.product.id }}, -1)">‚àí</button>
              <input type="number" name="qty_{{ row.product.id }}" value="{{ row.qty }}" min="1"
                    class="form-control text-center mx-2" style="width:60px;">
              <button type="button" class="btn btn-outline-secondary btn-sm" onclick="changeQty({{ row.product.id }}, 1)">+</button>
            </div>
          </td>

          <!-- T·ªïng ti·ªÅn -->
          <td class="text-danger fw-semibold subtotal">{{ row.subtotal|floatformat:0|intcomma }}‚Ç´</td>

          <!-- Thao t√°c -->
          <td>
            <a href="{% url 'remove_from_cart' row.product.id %}" class="text-danger text-decoration-none">X√≥a</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Footer gi·ªè h√†ng -->
    <div class="cart-footer d-flex justify-content-between align-items-center mt-4 p-3 border-top sticky-footer">
      <div class="cart-left d-flex align-items-center gap-4">
        <input type="checkbox" id="selectAll" class="form-check-input big-checkbox">
        <span class="select-all-text">Ch·ªçn t·∫•t c·∫£</span>
        <a href="#" class="text-danger text-decoration-none delete-link">X√≥a</a>
      </div>

      <div class="cart-right d-flex align-items-center gap-4">
        <div class="cart-total fw-semibold fs-5 mb-0">
          T·ªïng c·ªông: <span id="totalPrice" class="text-danger fw-bold">0‚Ç´</span>
        </div>
          <!-- ƒë√£ s·ª≠a -->
          <button type="submit" name="go" value="checkout"
            class="btn btn-danger px-4 py-2 fw-semibold checkout-btn"
            style="font-size: 16px;"
            onclick="return validateCheckout()">
            THANH TO√ÅN
        </button>
      </div>
    </div>
  </form>

  {% else %}
  <div class="text-center py-5">
    <img src="{% static 'assets/img/giohang.png' %}" alt="Gi·ªè h√†ng tr·ªëng" class="empty-cart-img mb-3" style="width:200px;">
    <h4>Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng</h4>
    <a href="{% url 'products' %}" class="btn btn-primary mt-3">Mua s·∫Øm ngay</a>
  </div>
  {% endif %}
</div>

<!-- ====================== JAVASCRIPT ====================== -->
<script>
// --- CSRF: l·∫•y t·ª´ cookie (theo docs Django) ---
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// --- TƒÉng/gi·∫£m s·ªë l∆∞·ª£ng + c·∫≠p nh·∫≠t d√≤ng & t·ªïng ---
function changeQty(id, delta) {
  const input = document.querySelector(`[name="qty_${id}"]`);
  const row = input.closest("tr");
  // ƒë√£ th√™m d√≤ng 
  const checkbox = row.querySelector('.item-checkbox'); 


  // Th√™m class="price" cho c·ªôt ƒë∆°n gi√° ƒë·ªÉ l·∫•y ch·∫Øc ch·∫Øn
  const priceText = row.querySelector(".price").innerText.replace(/[^\d]/g, "");
  const price = parseInt(priceText || '0');

  let qty = parseInt(input.value) || 1;
  qty = Math.max(1, qty + delta);
  input.value = qty;

  const subtotal = price * qty;
  row.querySelector(".subtotal").innerText = subtotal.toLocaleString("vi-VN") + "‚Ç´";
  
  // ƒë√£ s·ª≠a d√≤ng: Ch·ªâ c·∫≠p nh·∫≠t t·ªïng n·∫øu checkbox ƒë∆∞·ª£c ch·ªçn
  if (checkbox.checked) {
    updateTotal();
  }
}

function updateTotal() {
  let total = 0;
  let hasSelectedItems = false;  // ƒë√£ th√™m d√≤ng
  document.querySelectorAll(".item-checkbox:checked").forEach(checkbox => {
    hasSelectedItems = true;  // ƒë√£ th√™m d√≤ng
    const row = checkbox.closest("tr");
    const subtotalText = row.querySelector(".subtotal").innerText.replace(/[^\d]/g, "");
    total += parseInt(subtotalText || '0');
  });
  document.getElementById("totalPrice").innerText = total.toLocaleString("vi-VN") + "‚Ç´";

  // ƒë√£ th√™m: Disable n√∫t thanh to√°n n·∫øu kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c ch·ªçn
  //const checkoutBtn = document.querySelector('.checkout-btn');
  //if (checkoutBtn) {
  //  checkoutBtn.disabled = !hasSelectedItems;
  //  checkoutBtn.title = hasSelectedItems ? '' : 'Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n';
  //}

}

// ƒë√£ th√™m: h√†m ki·ªÉm tra n√†y sau h√†m updateTotal()
function updateSelectAllCheckbox() {
  const checkboxes = document.querySelectorAll(".item-checkbox");
  const selectAllCheckbox = document.getElementById("selectAll");
  
  if (checkboxes.length === 0) {
    selectAllCheckbox.checked = false;
    selectAllCheckbox.disabled = true;
    return;
  }
  
  selectAllCheckbox.disabled = false;
  
  const allChecked = Array.from(checkboxes).every(cb => cb.checked);
  const someChecked = Array.from(checkboxes).some(cb => cb.checked);
  
  selectAllCheckbox.checked = allChecked;
  selectAllCheckbox.indeterminate = someChecked && !allChecked;
}
// ƒë√£ th√™m
function validateCheckout() {
    const selectedItems = document.querySelectorAll('.item-checkbox:checked');
    const allItems = document.querySelectorAll(".item-checkbox");
    
    if (allItems.length === 0) {
        alert('Gi·ªè h√†ng tr·ªëng. Vui l√≤ng th√™m s·∫£n ph·∫©m tr∆∞·ªõc khi thanh to√°n.');
        return false;
    }
    
    if (selectedItems.length === 0) {
        alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n.');
        return false;
    }
    
    return true;
}

// Ch·ªçn t·∫•t c·∫£ (th√™m c·∫≠p nh·∫≠t checkbox)
document.getElementById("selectAll").addEventListener("change", function() {
  const checked = this.checked;
  // ƒë√£ s·ª≠a
  document.querySelectorAll(".item-checkbox").forEach(cb => {
    cb.checked = checked;
    // K√≠ch ho·∫°t s·ª± ki·ªán change ƒë·ªÉ c·∫≠p nh·∫≠t t·ªïng
    cb.dispatchEvent(new Event('change'));
  });
});

// Tick t·ª´ng d√≤ng - ƒë√£ th√™m c·∫≠p nh·∫≠t selectAll
document.querySelectorAll(".item-checkbox").forEach(cb => {
  cb.addEventListener("change", function() {
    updateTotal();
    updateSelectAllCheckbox();  // ƒë√£ th√™m d√≤ng
  });
});

// Xo√° c√°c d√≤ng ƒë√£ ch·ªçn (AJAX -> xo√° ·ªü session)
document.querySelector(".delete-link").addEventListener("click", function(e) {
  e.preventDefault();
  const checkedItems = document.querySelectorAll(".item-checkbox:checked");

  if (checkedItems.length === 0) {
    alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m ƒë·ªÉ x√≥a.");
    return;
  }

  if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${checkedItems.length} s·∫£n ph·∫©m ƒë√£ ch·ªçn kh√¥ng?`)) return;
  
  // ƒë√£ s·ª≠a
  const ids = Array.from(checkedItems).map(cb => cb.value);

  // D√πng URLSearchParams ƒë·ªÉ g·ª≠i d·∫°ng m·∫£ng product_ids[]
  const params = new URLSearchParams();
  ids.forEach(id => params.append('product_ids[]', id));

  fetch("{% url 'remove_selected_from_cart' %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": csrftoken
    },
    body: params
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      // Xo√° c√°c <tr> ƒë√£ tick tr√™n giao di·ªán
      checkedItems.forEach(cb => cb.closest("tr").remove());
      updateTotal();
      document.getElementById("selectAll").checked = false;

      // N·∫øu h·∫øt h√†ng -> render "gi·ªè h√†ng tr·ªëng"
      const remainingRows = document.querySelectorAll("tbody tr");
      if (remainingRows.length === 0) {
        document.querySelector(".cart-page").innerHTML = `
          <div class="text-center py-5">
            <img src="{% static 'assets/img/giohang.png' %}" alt="Gi·ªè h√†ng tr·ªëng" class="empty-cart-img mb-3" style="width:200px;">
            <h4>Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng</h4>
            <a href="{% url 'products' %}" class="btn btn-primary mt-3">MUA S·∫ÆM NGAY</a>
          </div>
        `;
      }
    } else {
      alert("Kh√¥ng xo√° ƒë∆∞·ª£c s·∫£n ph·∫©m. Vui l√≤ng th·ª≠ l·∫°i.");
    }
  })
  .catch(() => alert("L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i."));
});

// ƒë√£ th√™m: NgƒÉn ch·∫∑n thanh to√°n n·∫øu kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c ch·ªçn
document.querySelector('form').addEventListener('submit', function(e) {
  const selectedItems = document.querySelectorAll('.item-checkbox:checked');
  const allItems = document.querySelectorAll(".item-checkbox");
  const cartIsEmpty = allItems.length === 0;
  
  if (cartIsEmpty) {
    e.preventDefault();
    alert('Gi·ªè h√†ng tr·ªëng. Vui l√≤ng th√™m s·∫£n ph·∫©m tr∆∞·ªõc khi thanh to√°n.');
    return false;
  }
  
  if (selectedItems.length === 0) {
    e.preventDefault();
    alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n.');
    return false;
  }
  
  // N·∫øu c√≥ s·∫£n ph·∫©m ƒë∆∞·ª£c ch·ªçn, cho ph√©p submit b√¨nh th∆∞·ªùng
  // Form s·∫Ω g·ª≠i ƒë·∫øn update_cart v√† chuy·ªÉn h∆∞·ªõng ƒë·∫øn checkout
});

// Kh·ªüi t·∫°o t·ªïng ti·ªÅn khi trang load
document.addEventListener('DOMContentLoaded', function() {
  updateTotal();
  updateSelectAllCheckbox(); // ƒë√£ th√™m
});

</script>


{% endblock %}
